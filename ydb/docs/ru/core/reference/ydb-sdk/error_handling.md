# Обработка ошибок

При использовании {{ ydb-short-name }} SDK возникают ситуации, в которых необходимо обрабатывать ошибки.

Ошибки можно разделить на три категории:

* **Временные сбои** (retryable) — включают в себя кратковременную потерю сетевого соединения, временную недоступность или перегруженность одной из подсистем {{ ydb-short-name }}, неспособность {{ ydb-short-name }} ответить на запрос в течение установленного времени ожидания. В случае возникновения таких ошибок, повтор запроса, завершившегося с ошибкой, через некоторый промежуток времени с большой вероятностью будет выполнен успешно.

* **Ошибки, которые не могут быть исправлены с помощью повтора** (non retryable) — включают в себя некорректно сформированные запросы, внутренние ошибки {{ ydb-short-name }}, запросы, несоответствующие схеме данных. В такой ситуации нет необходимости повторять запрос, требуется дополнительное вмешательство со стороны разработчика.

* **Ошибки, которые, предположительно, могут быть исправлены с помощью повтора после реакции клиентского приложения** (conditionally retryable) — идемпотентные операции, которые включают в себя отсутствие ответа в течение отведенного времени, запрос аутентификации.

## Обработка временных сбоев (retryable errors) {#handling-retryable-errors}

{{ ydb-short-name }} SDK предоставляет [встроенный механизм обработки временных сбоев](../../recipes/ydb-sdk/retry.md). По умолчанию в SDK используется рекомендованная политика повторов, которую можно изменить в соответствии с требованиями клиентского приложения. {{ ydb-short-name }} возвращает коды завершения, которые позволяют определить, уместна ли повторная попытка и какой выбрать интервал.

Операции следует повторять только в том случае, когда ошибки являются временными сбоями. Не пытайтесь выполнить повторно недопустимые операции, такие как вставка в таблицу строки с существующим значением первичного ключа или вставка данных несоответствующих схеме таблицы.

Крайне важно оптимизировать число повторных попыток и интервал между ними. Чрезмерное количество повторных попыток и слишком короткий интервал между ними создают избыточную нагрузку. Недостаточное количество повторных попыток не позволит завершить выполнение операции.

Встроенные в SDK {{ ydb-short-name }} retryer'ы используют следующие стратегии задержек повторного выполнения запросов в зависимости от статуса завершения запроса:

* Немедленный повтор. Повторные попытки совершаются немедленно.
* Короткая экспоненциальная задержка. Первоначальный интервал составляет несколько миллисекунд. Для каждой последующей попытки интервал увеличивается по экспоненциальному закону.
* Большая экспоненциальная задержка. Первоначальный интервал составляет несколько секунд. Для каждой последующей попытки интервал увеличивается по экспоненциальному закону.

При выборе интервала вручную обычно используются следующие стратегии:

* Экспоненциальная задержка. Для каждой последующей попытки интервал увеличивается по экспоненциальному закону.
* Интервалы с приращениями. Для каждой последующей попытки интервал увеличивается с определенными приращениями.
* Постоянные интервалы. Повторные попытки совершаются через одинаковые интервалы.
* Немедленный повтор. Повторные попытки совершаются немедленно.
* Случайный выбор. Повторные попытки совершаются через случайно выбранный интервал времени.

При выборе интервала и числа повторных попыток учитывайте [статусы завершения](#status-codes) {{ ydb-short-name }}.

Не используйте бесконечные повторные попытки. Это может привести к возникновению избыточной нагрузки.

Не выполняйте немедленный повтор больше одного раза.

Примеры кода смотрите в разделе [{#T}](../../recipes/ydb-sdk/retry.md).

## Статусы завершения {#status-codes}

Когда возникает ошибка, YDB SDK возвращает объект ошибки, который включает статусы завершения. Возвращаемый статус завершения может исходить от [сервера {{ ydb-short-name }}](./ydb-status-codes.md), [транспорта gRPC](./grpc-status-codes.md) или самого SDK.

Статусы завершения в диапазоне 400000–400999 — это статусы завершения, полученные от сервера YDB. Смотрите [{#T}](./ydb-status-codes.md).

Статусы завершения в диапазоне 401000–401999 относятся к кодам, специфичным для SDK. Для получения дополнительной информации об этих статусах, относящихся к конкретному SDK, обратитесь к соответствующей документации SDK.

Для получения дополнительной информации о статусах завершения gRPC см. [документацию gRPC](https://grpc.io/docs/guides/status-codes/).

## Журналирование ошибок {#log-errors}

При использовании SDK рекомендуется записывать в журнал все ошибки и исключения:

* Журналируйте количество предпринимаемых повторных попыток. Увеличение числа регулярных повторных попыток часто указывает на наличие проблем.
* Журналируйте все ошибки, в том числе их типы, коды завершения и причины, вызывающие их появление.
* Журналируйте общее время выполнения операций, в том числе завершающихся после повторного выполнения.

## See also

- [{#T}](./grpc-status-codes.md)
- [{#T}](./ydb-status-codes.md)
- [Questions and answers: Errors](../../faq/errors.md)
